<script>
  import { onMount } from 'svelte';
  import FeedList from './lib/FeedList.svelte';
  import ArticleList from './lib/ArticleList.svelte';
  import ArticleDetail from './lib/ArticleDetail.svelte';
  import HeadlineMarquee from './lib/HeadlineMarquee.svelte';
  import { fetchFeeds } from './lib/api';

  let selectedFeedId = null;
  let selectedArticle = null;
  let rawArticles = [];
  let loading = false;
  let error = null;
  let feeds = [];
  let feedMap = {};
  let page = 0;
  let hasMore = true;
  const PAGE_SIZE = 100;

  async function loadAllArticles(reset = false) {
    if (reset) {
      page = 0;
      rawArticles = [];
      hasMore = true;
    }
    
    if (!hasMore || loading) return;
    
    loading = true;
    error = null;
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);
    try {
      const res = await fetch(`/rss-articles?skip=${page * PAGE_SIZE}&limit=${PAGE_SIZE}`, { signal: controller.signal });
      if (!res.ok) throw new Error(`API returned ${res.status}`);
      const text = await res.text();
      console.log('response api text:', text);
      try {
        const newArticles = JSON.parse(text);
        if (newArticles.length < PAGE_SIZE) {
          hasMore = false;
        }
        rawArticles = [...rawArticles, ...newArticles];
        page++;
      } catch {
        throw new Error('Invalid JSON response');
      }
    } catch (e) {
      if (e.name === 'AbortError') {
        error = 'Request timed out, please try again later';
      } else {
        error = e.message;
      }
    } finally {
      loading = false;
      clearTimeout(timeoutId);
    }
  }

  async function loadAllFeeds() {
    try {
      feeds = await fetchFeeds();
      feedMap = Object.fromEntries(feeds.map(f => [f.id, f.name]));
    } catch (e) {
      // ignore
    }
  }

  function handleScroll(event) {
    const container = event.target;
    const scrollBottom = container.scrollHeight - container.scrollTop - container.clientHeight;
    if (scrollBottom < 100) { // 当距离底部100px时加载更多
      loadAllArticles();
    }
  }

  function handleLoadMore() {
    loadAllArticles();
  }

  onMount(async () => {
    await Promise.all([loadAllFeeds(), loadAllArticles(true)]);
  });

  $: allArticles = rawArticles
    .filter(a => a?.id && a.title && a.published_at)
    .sort((a, b) => new Date(b.published_at).getTime() - new Date(a.published_at).getTime());

  function handleFeedSelect(event) {
    selectedFeedId = event.detail.feedId;
    selectedArticle = null;
  }

  function handleArticleSelect(event) {
    const article = event.detail.article;
    if (selectedArticle && selectedArticle.id === article.id) {
      selectedArticle = null;
    } else {
      selectedArticle = article;
    }
  }
</script>

<main>
  <header class="header">
    <h1>Forarger Stream</h1>
  </header>

  <section class="marquee-container">
    {#if loading && page === 0}
      <div class="skeleton-marquee"></div>
    {:else}
      {#if error}
        <div class="marquee-error">Marquee load error: {error}</div>
      {/if}
      <HeadlineMarquee articles={allArticles} />
    {/if}
  </section>

  <div class="layout">
    <aside class="sidebar">
      <FeedList on:select={handleFeedSelect} />
    </aside>
    <section class="main-content {selectedArticle ? 'with-detail' : ''}">
      <div class="article-list" on:scroll={handleScroll}>
        <ArticleList
          feedId={selectedFeedId}
          allArticles={allArticles}
          paused={!!selectedArticle}
          selectedArticle={selectedArticle}
          feedMap={feedMap}
          on:select={handleArticleSelect}
          on:loadMore={handleLoadMore}
        />
        {#if loading && page > 0}
          <div class="loading-more">Loading more articles...</div>
        {/if}
      </div>
      {#if selectedArticle}
        <div class="article-detail">
          <ArticleDetail article={selectedArticle} on:close={() => selectedArticle = null} />
        </div>
      {/if}
    </section>
  </div>
</main>

<style>
  :root {
    --color-bg: #fafafa;
    --color-surface: #ffffff;
    --color-primary: #4a90e2;
    --color-on-primary: #ffffff;
    --color-text: #333333;
    --color-muted: #777777;
    --color-border: #e0e0e0;
    --radius: 8px;
    --spacing: 16px;
  }

  :global(html) {
    font-size: 70%;
  }

  :global(body) {
    margin: 0;
    font-size: 1.4rem;
    font-family: "Helvetica Neue", Arial, sans-serif;
    background: var(--color-bg);
    color: var(--color-text);
  }

  main { display: flex; flex-direction: column; height: 100vh; }
  .header {
    position: sticky; top: 0;
    background: var(--color-surface);
    padding: var(--spacing);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    z-index: 10;
  }
  .header h1,
  .feed-header h2,
  .article-title {
    margin: 0;
    color: var(--color-primary);
    font-size: 1rem; /* 11px */
  }

  .marquee-container {
    position: sticky; top: 64px;
    background: var(--color-surface);
    padding: var(--spacing);
    border-bottom: 1px solid var(--color-border);
    z-index: 9;
  }
  .marquee-error {
    color: #d32f2f;
    margin-bottom: var(--spacing);
    text-align: center;
  }

  .layout { flex: 1; display: flex; overflow: hidden; }
  .sidebar {
    width: 260px;
    background: var(--color-surface);
    border-right: 1px solid var(--color-border);
    padding: var(--spacing);
    overflow-y: auto;
  }
  .main-content { flex: 1; display: flex; overflow: hidden; }

  .article-list,
  .article-detail {
    background: var(--color-surface);
    margin: var(--spacing);
    border-radius: var(--radius);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    /* overflow-y: auto; */
  }
  .article-list { width: 320px; padding: var(--spacing); }
  .article-detail { flex: 1; padding: var(--spacing); }

  .skeleton-marquee {
    height: 2rem;
    background: var(--color-border);
    border-radius: var(--radius);
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse { 0%{opacity:1;}50%{opacity:0.4;}100%{opacity:1;} }

  @media (max-width: 1024px) {
    .layout { flex-direction: column; }
    .sidebar { width: 100%; max-height: 200px; }
    .main-content { flex-direction: column; }
    .article-list { width: 100%; max-height: 300px; }
    .article-detail { margin: var(--spacing) 0; }
  }

  /* 动态两栏/三栏切换 */
  .main-content:not(.with-detail) .article-list {
    width: 100%;
  }
  .main-content:not(.with-detail) .article-detail {
    display: none;
  }

  .loading-more {
    text-align: center;
    padding: 1rem;
    color: var(--color-text-secondary);
    font-size: 0.9rem;
  }
</style>
